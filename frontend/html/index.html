<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Rudolf</title>

<!-- Stile base -->
<style>
/* Body e font epico */
body {
    background: linear-gradient(135deg, #0b0b0d 0%, #1a1a1f 100%);
    color: #f5f5f5;
    font-family: 'Fira Code', 'Courier New', monospace;
    margin: 0;
    padding: 20px;
    overflow-x: hidden;
}

#op {
    max-width: 100%;
    margin: auto;
    padding: 20px;
    background: rgba(20, 20, 25, 0.85);
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(0,0,0,0.7);
    min-height: 6vh;
    overflow-y: auto;
}

#status {
    max-width: 100%;
    margin: auto;
    padding: 20px;
    background: rgba(20, 20, 25, 0.85);
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(0,0,0,0.7);
    min-height: 6vh;
    overflow-y: auto;
    color: white;
}

/* Contenitore chat */
#chat {
    max-width: 1000px;
    min-width: 1000px;
    /*margin: auto;*/
    padding: 20px;
    background: rgba(20, 20, 25, 0.85);
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(0,0,0,0.7);
    max-height: 70vh;
    min-height: 70vh;
    overflow-y: auto;
    float: left;
}

/* Messaggi base */
.msg {
    margin: 12px 0;
    padding: 12px 16px;
    border-radius: 10px;
    line-height: 1.5;
    word-wrap: break-word;
    white-space: pre-wrap;
    transition: all 0.3s ease-in-out;
}

/* Messaggi utente */
.user {
    background: linear-gradient(120deg, #2c2c5c, #3a3a70);
    border-left: 4px solid #4ea1ff;
    color: #cce0ff;
    text-shadow: 0 0 2px rgba(0,0,0,0.7);
}

/* Messaggi AI con gradient animato */
.bot {
    background: linear-gradient(120deg, #1b1b1b, #2a2a2a);
    border-left: 4px solid #9cff57;
    color: #b8f27b;
    text-shadow: 0 0 3px rgba(0,0,0,0.5);
    background-size: 400% 400%;
    animation: gradientAnim 10s ease infinite;
}

/* Messaggi op */
.op {
    background: linear-gradient(120deg, #2c2c5c, #3a3a70);
    border-left: 4px solid #4ea1ff;
    color: #cce0ff;
    text-shadow: 0 0 2px rgba(0,0,0,0.7);
    padding: 3px !important;
    margin: 3px !important;
}

/* Gradient animato AI */
@keyframes gradientAnim {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Thinking */
.thinking {
    font-style: italic;
    color: #888;
    background: transparent;
    border-left: 4px dashed #aaa;
}

#model {
    width: 99%;
}

#input {
    width: 98%;
}

/* Input e select */
input, select {
    padding: 14px;
    margin-top: 10px;
    font-size: 16px;
    background: #0e0e12;
    color: #eee;
    border: 1px solid #444;
    border-radius: 8px;
    outline: none;
    transition: 0.2s;
}

input:focus, select:focus {
    border-color: #9cff57;
    box-shadow: 0 0 10px rgba(156, 255, 87, 0.4);
}

/* Code block con glow animato */
code {
    background: #1c1c25;
    padding: 2px 5px;
    border-radius: 4px;
    font-family: 'Fira Code', monospace;
    color: #ffdd55;
}

pre {
    background: #1c1c25;
    padding: 12px;
    border-radius: 8px;
    overflow-x: auto;
    color: #ffdd55;
    font-family: 'Fira Code', monospace;
    box-shadow: 0 0 8px rgba(255, 221, 85, 0.4);
    animation: glowPulse 2s ease-in-out infinite;
}

@keyframes glowPulse {
    0%,100% { box-shadow: 0 0 8px rgba(255, 221, 85, 0.4); }
    50% { box-shadow: 0 0 16px rgba(255, 221, 85, 0.8); }
}

/* Scrollbar dark style */
#chat::-webkit-scrollbar {
    width: 10px;
}

#chat::-webkit-scrollbar-track {
    background: #111;
}

#chat::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 5px;
}

#chat::-webkit-scrollbar-thumb:hover {
    background: #666;
}

/* Cursore lampeggiante per bot in streaming */
/*.bot::after {
    content: '|';
    display: inline-block;
    margin-left: 2px;
    color: #9cff57;
    animation: blink 1s step-end infinite;
}*/

@keyframes blink {
    50% { opacity: 0; }
}

.thinking-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    font-size: 14px;
    color: #aaa;
    cursor: pointer;
}

.thinking-toggle input {
    accent-color: #9cff57;
    cursor: pointer;
}

.didascalia {
}

</style>

<!-- Librerie per Markdown + evidenziazione code -->
<script src="/js/marked.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/github-dark.min.css">
<script src="/js/highlight.min.js"></script>
<script src="/js/purify.min.js"></script>

</head>
<body>

<div class="didascalia">&nbsp;Prompt</div>
<br>
<div id="chat"></div>
<div class="didascalia">&nbsp;System</div>
<br>
<div id="status">
  <span id="ws_status">Websocket status: ...</span>
  <br>
  <span id="ws_op">Websocket operation: ...</span>
  <br>
  Context language:&nbsp;
  <select id="language">
    <option value="english">English</option>
    <option value="italian">Italian</option>
    <option value="french">French</option>
  </select>
  <label class="thinking-toggle">
    <input type="checkbox" id="thinking" checked>
    Thinking enabled
  </label>
</div>

<br>
<div class="didascalia">&nbsp;Event logs</div>
<br>
<div id="op"></div>

<select id="model">
  <option value="mistral">mistral</option>
  <option value="gpt-oss:20b">gpt-oss:20b</option>
  <option value="gpt-oss:120b">gpt-oss:120b</option>
  <option value="saki007ster/CybersecurityRiskAnalyst:latest">saki007ster/CybersecurityRiskAnalyst</option>
  <option value="deepseek-r1">deepseek-r1</option>
</select>

<input id="input" placeholder="Scrivi e premi invio..." />

<script>
const ws = new WebSocket(
  (location.protocol === "https:" ? "wss://" : "ws://")
  + location.host + "/ws"
);

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const modelSelect = document.getElementById("model");
const languageSelect = document.getElementById("language");
const thinkingCheckbox = document.getElementById("thinking");
const op = document.getElementById("op");
const ws_status = document.getElementById("ws_status");
const ws_op = document.getElementById("ws_op");

let botMsg;
let botMsgText = "";
let thinkingMsg;

let op_in_progress = 0;

ws_status.textContent = "Websocket status: connected";
ws_op.textContent = "Websocket operation: available";

ws.onclose = e => {
  console.warn("WebSocket closed", e.code, e.reason);
  op_in_progress = 0;
  ws_status.textContent = "Websocket status: not connected";
  ws_op.textContent = "Websocket operation: not available";
  alert("Websocket connection closed")
};

ws.onerror = e => {
  console.error("WebSocket error", e);
  ws.close();
  ws_status.textContent = "Websocket status: not connected due to error (" + e + ")";
  ws_op.textContent = "Websocket operation: not available";
  alert("Websocket closed due to error: " + e);
};

ws.onmessage = e => {
  if (e.data === "__END__") {
    let html = marked.parse(botMsgText).trim();
    botMsg.innerHTML = DOMPurify.sanitize(html);

    botMsg.querySelectorAll('pre code').forEach(el => {
      hljs.highlightElement(el);
    });

    requestAnimationFrame(() => {
      chat.scrollTop = chat.scrollHeight;
    });

    op_in_progress = 0;
    ws_op.textContent = "Websocket operation: available";
    return;
  }

  // Messaggi di errore
  if (e.data.startsWith("___ERROR___")) {
    thinkingMsg.textContent += e.data.replace("___ERROR___", "");
    return; 
  } 

  // Messaggi CTX
  if (e.data.startsWith("___CTX___")) {
    const opDiv = document.createElement("div");
    opDiv.className = "msg op";
    opDiv.textContent = e.data.replace("___CTX___", "");
    op.appendChild(opDiv);
    return;
  }

  // Messaggi di thinking
  if (e.data.startsWith("___THINKING___")) {
    thinkingMsg.textContent += e.data.replace("___THINKING___", "");

    requestAnimationFrame(() => {
      chat.scrollTop = chat.scrollHeight;
    });

    return;
  }

  // Token AI in streaming
  if (e.data.startsWith("___TOKEN___")) {
    botMsgText += e.data.replace("___TOKEN___", "");
    botMsg.textContent += e.data.replace("___TOKEN___", "");

    requestAnimationFrame(() => {
      chat.scrollTop = chat.scrollHeight;
    });

    return;
  }
};

input.addEventListener("keydown", e => {
  if (e.key !== "Enter" || !input.value.trim()) return;

  const text = input.value;
  input.value = "";

  // Messaggio utente
  const userDiv = document.createElement("div");
  userDiv.className = "msg user";
  userDiv.textContent = "Tu: " + text;
  chat.appendChild(userDiv);

  // Thinking message
  thinkingMsg = document.createElement("div");
  thinkingMsg.className = "thinking bot";
  thinkingMsg.textContent = "Thinking: ";
  chat.appendChild(thinkingMsg);

  // Messaggio AI
  botMsg = document.createElement("div");
  botMsg.className = "msg bot";
  botMsgText = "";
  botMsg.textContent = "AI: ";
  chat.appendChild(botMsg);

  if(op_in_progress == 0) {
    ws_op.textContent = "Websocket operation: in progress";
    op_in_progress = 1;
    op.innerHTML = "";
    ws.send(JSON.stringify({
      prompt: text,
      model: modelSelect.value,
      language: languageSelect.value,
      thinking: thinkingCheckbox.checked
    }));
  }
  else {
    alert("Operation already in progress, wait please");
  }
});
</script>

</body>
</html>
